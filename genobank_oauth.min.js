class GenoBankLogin{constructor(e="genobank-oauth-button"){this.containerId=e}async init(){try{const e=document.getElementById(this.containerId);if(!e)return void console.error(`Container #${this.containerId} not found`);e.innerHTML='<button id="openGenobankBtn">Open Genobank Authentication</button>',document.getElementById("openGenobankBtn").addEventListener("click",(async()=>{try{await this.openPopup()}catch(e){console.error("Error closed popup:",e)}}));const t=new URLSearchParams(window.location.search).get("data");if(t)try{const e=atob(t).replace(/'/g,'"');if(e){const t=await this.verifyJWT(e);this.saveUserLogin(t?.payload?.genobank_login),this.clearQueryParams()}}catch(e){console.error("❌ Error during decoding 'data':",e.message)}}catch(e){}}openPopup(e=(()=>{})){return new Promise(((t,o)=>{const n=`../?data=${btoa(`{'isPopup':true, 'source':'${window.location.href}'}`)}`,{left:r,top:a}=this.getLeftAndTop(450,700),i=`\n                width=450,\n                height=700,\n                top=${a},\n                left=${r},\n                toolbar=no,\n                location=no,\n                status=no,\n                menubar=no,\n                scrollbars=no,\n                resizable=no\n            `.replace(/\s+/g,""),s=window.open(n,"title window",i);if(!s)return void o("Navigator locked the popup");const c=o=>{if(void 0!==o.data.genobankLogin){this.saveUserLogin(o.data.genobankLogin);try{e(o.data.genobankLogin)}catch(e){console.error("CallBack error:",e)}window.removeEventListener("message",c),t(o.data)}};window.addEventListener("message",c);const l=setInterval((()=>{s.closed&&(clearInterval(l),window.removeEventListener("message",c),o("El popup fue cerrado sin enviar datos"))}),500)}))}getLeftAndTop(e,t){const o=void 0!==window.screenLeft?window.screenLeft:window.screenX,n=void 0!==window.screenTop?window.screenTop:window.screenY;return{left:o+((window.innerWidth||document.documentElement.clientWidth||screen.width)-e)/2,top:n+((window.innerHeight||document.documentElement.clientHeight||screen.height)-t)/2}}redirectWithEncryptedData(){const e=btoa(`{'isPopup':false,'source':'${window.location.origin}${window.location.pathname}'}`);location.href=`../?data=${e}`}getUserWallet(){return localStorage.getItem("user_wallet")}getLoginMethod(){return localStorage.getItem("login_method")}isLoggedIn(){return!!this.getUserSignature()||!!this.getDidToken()}getUserSignature(){return localStorage.getItem("user_signature")}getDidToken(){return localStorage.getItem("magic_token")}removeUserTokens(){["magic_token","user_signature","user_wallet","login_method","isPermittee","email","name","picture","registration"].forEach((e=>localStorage.removeItem(e)))}saveUserLogin(e){e&&(localStorage.setItem("user_wallet",e.userWallet||""),localStorage.setItem("user_signature",e.userSignature||""),localStorage.setItem("login_method",e.loginMethod||""),e.magicToken&&localStorage.setItem("magic_token",e.magicToken),e.email&&localStorage.setItem("email",e.email),e.name&&localStorage.setItem("name",e.name),e.picture&&localStorage.setItem("picture",e.picture),e.registration&&localStorage.setItem("registration",e.registration))}async getValidatePermittee(e){const t=new URL("https://genobank.app/validate_permittee");return t.searchParams.append("permittee",e),fetch(t,{method:"GET",headers:{"Content-type":"application/json; charset=UTF-8"}}).then((e=>e.json())).catch((e=>({errors:[{message:e}]})))}async verifyJWT(e){const t=new URL("http://localhost:8081/verify_jwt");return fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jwt:e})}).then((e=>e.json())).catch((e=>console.error("Error:",e)))}clearQueryParams(){const e=new URL(window.location);e.search="",window.history.replaceState({},"",e)}logout(e=!1){this.removeUserTokens(),e&&window.location.reload()}}